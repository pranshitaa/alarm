<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pixel Alarm Clock</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(#fdf6e3, #ffe6f0);
            text-align: center;
            margin: 0;
            padding: 20px;
            color: #6d28d9;
        }
        h1 {
            font-size: 24px;
            margin-top: 20px;
            color: #ff66b2;
        }
        #current-time {
            font-size: 48px;
            margin: 20px;
        }
        input, button {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            padding: 10px;
            margin: 8px;
            border: 2px solid #8b5cf6;
            border-radius: 12px;
            background-color: #f9f5ff;
            transition: all 0.3s ease;
        }
        input:hover, button:hover {
            background-color: #e0d7f5;
            cursor: pointer;
        }
        ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        li {
            background: #f3e8ff;
            margin: 10px auto;
            padding: 15px;
            border-radius: 12px;
            width: 320px;
            box-shadow: 3px 3px #c084fc;
            font-size: 10px;
        }
    </style>
</head>
<body onload="startClock()">

<h1>ðŸŒ¸ Pixel Alarm Clock ðŸŒ¸</h1>

<div id="current-time">00:00:00</div>

<form action="/alarms/create" method="post">
    <input type="datetime-local" name="time" id="alarmTime" required />
    <input type="text" name="purpose" placeholder="Purpose" required />
    <button type="submit">Set Alarm</button>
</form>

<h2>ðŸŸ¢ Active Alarms</h2>
<ul id="active-alarms">
    <th:block th:each="alarm : ${alarms}">
        <li>
            <span th:text="${alarm.purpose}">Purpose</span> at 
            <span th:text="${#temporals.format(alarm.alarmTime, 'yyyy-MM-dd HH:mm')}">Time</span>
            <button th:id="'disable-' + ${alarm.id}" style="display:none;" onclick="disableAlarmNow('[[${alarm.id}]]')">Disable</button>
        </li>
    </th:block>
</ul>

<audio id="alarm-sound" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/08/08/audio_1abf25cb8a.mp3" type="audio/mpeg">
</audio>

<script th:inline="javascript">
/*<![CDATA[*/
let alarms = /*[[${alarms}]]*/ [];
/*]]>*/

function startClock() {
    setInterval(updateTime, 1000);
    setInterval(checkAlarms, 1000);
    setAlarmDefaultTime();
}

function setAlarmDefaultTime() {
    const now = new Date();
    now.setSeconds(0, 0);
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const date = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const formatted = `${year}-${month}-${date}T${hours}:${minutes}`;
    document.getElementById('alarmTime').value = formatted;
}

function updateTime() {
    const now = new Date();
    const clock = document.getElementById('current-time');
    let hours = now.getHours().toString().padStart(2, '0');
    let minutes = now.getMinutes().toString().padStart(2, '0');
    let seconds = now.getSeconds().toString().padStart(2, '0');
    clock.textContent = `${hours}:${minutes}:${seconds}`;
}

function checkAlarms() {
    const now = new Date();
    for (let alarm of alarms) {
        if (alarm.isActive) {
            let alarmTime = new Date(alarm.alarmTime);
            alarmTime = new Date(alarmTime.getTime() - (alarmTime.getTimezoneOffset() * 60000));

            const nowStr = now.getFullYear() + '-' +
                           (now.getMonth() + 1).toString().padStart(2, '0') + '-' +
                           now.getDate().toString().padStart(2, '0') + 'T' +
                           now.getHours().toString().padStart(2, '0') + ':' +
                           now.getMinutes().toString().padStart(2, '0');

            const alarmStr = alarmTime.getFullYear() + '-' +
                             (alarmTime.getMonth() + 1).toString().padStart(2, '0') + '-' +
                             alarmTime.getDate().toString().padStart(2, '0') + 'T' +
                             alarmTime.getHours().toString().padStart(2, '0') + ':' +
                             alarmTime.getMinutes().toString().padStart(2, '0');

            if (nowStr === alarmStr) {
                document.getElementById('disable-' + alarm.id).style.display = 'inline-block';
                playSound();
            }
        }
    }
}

function disableAlarmNow(id) {
    fetch(`/alarms/disable/${id}`, { method: 'POST' })
        .then(() => {
            stopSound();
            window.location.href = `/alarms/ringing?purpose=Alarm&time=now&id=${id}`;
        });
}

function playSound() {
    const sound = document.getElementById('alarm-sound');
    sound.play();
}

function stopSound() {
    const sound = document.getElementById('alarm-sound');
    sound.pause();
    sound.currentTime = 0;
}
/*]]>*/
</script>

</body>
</html>
